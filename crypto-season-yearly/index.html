<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>연도별 시즌널리티 분석 | Herdvibe</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg0:#000;--bg1:#07070d;--bg2:#0d0d16;--bg3:#13131f;--bg4:#1a1a2a;--bdr:#1a1a2e;--bdr2:#282845;--t1:#e8e8f0;--t2:#b0b0c8;--t3:#8888a0;--t4:#686880;--g:#00ff88;--r:#ff4466;--b:#4488ff;--y:#ffcc00}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth;-webkit-font-smoothing:antialiased;overflow-x:hidden}
body{font-family:'Noto Sans KR',system-ui,sans-serif;background:var(--bg0);color:var(--t1);line-height:1.6;min-height:100vh;overflow-x:hidden}
a{color:var(--g);text-decoration:none}::selection{background:var(--b);color:#fff}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--bg1)}::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:3px}
.hdr{padding:12px 28px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;background:var(--bg1);position:sticky;top:0;z-index:100;backdrop-filter:blur(20px)}
.hdr-title{font-weight:700;font-size:15px;color:#fff}
.page{max-width:960px;margin:0 auto;padding:20px 28px}
.coin-tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:2px 0;flex-wrap:wrap}
.coin-tabs::-webkit-scrollbar{display:none}
.ctab{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bdr);border-radius:8px;cursor:pointer;transition:all .2s;flex-shrink:0}
.ctab:hover{background:var(--bg3);border-color:var(--bdr2)}
.ctab.on{background:var(--bg4);border-color:var(--y);box-shadow:0 0 12px rgba(255,204,0,.08)}
.ctab-icon{width:26px;height:26px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ctab-icon img{width:100%;height:100%;object-fit:cover}
.ctab-info{display:flex;flex-direction:column}
.ctab-name{font-weight:600;font-size:.8rem;color:var(--t1)}
.ctab-price{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--t3)}
.ctab-price.live{color:var(--t2)}
.filter-tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.ftab{padding:7px 14px;background:var(--bg2);border:1px solid var(--bdr);border-radius:6px;font-size:.75rem;font-weight:500;color:var(--t3);cursor:pointer;transition:all .2s;font-family:inherit}
.ftab:hover{background:var(--bg3);color:var(--t2)}
.ftab.on{background:var(--bg4);border-color:var(--b);color:var(--b);box-shadow:0 0 10px rgba(68,136,255,.1)}
.chart-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:11px;overflow:hidden;margin-bottom:20px}
.chart-head{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--bdr);flex-wrap:wrap;gap:8px}
.chart-head h3{font-family:'Plus Jakarta Sans',sans-serif;font-size:.875rem;font-weight:600;color:var(--t1)}
.chart-legend{display:flex;gap:12px;flex-wrap:wrap}
.leg{display:flex;align-items:center;gap:4px;font-size:.65rem;color:var(--t3)}
.ldot{width:8px;height:8px;border-radius:50%}
.ldot.best{background:var(--g)}.ldot.worst{background:var(--r)}.ldot.avg{background:transparent;border:2px dashed #888}.ldot.cur{background:var(--y)}.ldot.sel{background:var(--b)}
.chart-area{height:380px;position:relative;padding:12px 20px}
.ytable-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.ytable-wrap::-webkit-scrollbar{display:none}
.ytable{width:100%;border-collapse:collapse;font-family:'JetBrains Mono',monospace;font-size:.75rem;min-width:500px}
.ytable th{padding:10px 12px;text-align:left;font-weight:600;font-size:.65rem;color:var(--t4);text-transform:uppercase;letter-spacing:.05em;background:var(--bg1);border-bottom:1px solid var(--bdr);white-space:nowrap}
.ytable th.r{text-align:right}
.ytable td{padding:8px 12px;border-bottom:1px solid var(--bdr);color:var(--t2)}
.ytable td.r{text-align:right}
.ytable tr:hover td{background:var(--bg3)}
.ytable tr{cursor:pointer;transition:background .15s}
.ytable tr.sel td{background:rgba(68,136,255,.12)}
.ytable .up{color:var(--g)}.ytable .dn{color:var(--r)}
.ytable .yr-cell{font-weight:600;color:var(--t1)}
.share-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;margin-top:28px;background:var(--bg1);border:1px solid var(--bdr);border-radius:10px}
.share-bar-preview{font-size:11px;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:55%;font-family:'JetBrains Mono',monospace}
.share-bar-preview b{color:var(--t2);font-weight:600}
.share-bar-buttons{display:flex;align-items:center;gap:6px;flex-shrink:0}
.share-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;border:1px solid var(--bdr2);background:var(--bg2);color:var(--t3);white-space:nowrap;font-family:inherit}
.share-btn:hover{transform:translateY(-1px);color:var(--t1)}
.share-btn svg{flex-shrink:0}
.share-btn--x:hover{border-color:#fff;color:#fff;background:var(--bg3)}
.share-btn--kakao:hover{border-color:#FEE500;color:#191919;background:#FEE500}
.share-btn--tg:hover{border-color:#26A5E4;color:#fff;background:rgba(38,165,228,.15)}
.share-btn--ig:hover{border-color:#E4405F;color:#fff;background:rgba(228,64,95,.15)}
.share-btn--copy:hover{border-color:var(--g);color:var(--g);background:rgba(0,255,136,.07)}
.inline-share{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 0;border-top:1px solid var(--bdr)}
.inline-share .lbl{font-size:10px;color:var(--t4);margin-right:4px}
.inline-share .share-btn{padding:6px 10px}
.toast-wrap{position:fixed;bottom:20px;right:20px;z-index:999}
.toast{background:var(--bg4);border:1px solid var(--bdr2);border-left:3px solid var(--g);border-radius:8px;padding:10px 18px;font-size:12px;color:var(--t1);box-shadow:0 8px 32px rgba(0,0,0,.7);animation:toastIn .3s ease}
@keyframes toastIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:768px){
.page{padding:12px 16px}.hdr{padding:8px 16px}
.chart-area{height:280px;padding:10px}
.chart-head{flex-direction:column;align-items:flex-start;gap:8px;padding:12px 14px}
.share-bar{flex-direction:column;gap:10px;align-items:stretch}
.share-bar-preview{max-width:100%}
.share-bar-buttons{justify-content:center;flex-wrap:wrap}
.share-btn .lbl{display:none}.share-btn{padding:8px 10px}
.inline-share .lbl{display:none}
.ctab{padding:6px 8px;gap:5px}.ctab-icon{width:22px;height:22px}.ctab-name{font-size:.7rem}.ctab-price{font-size:.55rem}
}
@media(max-width:520px){
.page{padding:10px 10px}.chart-area{height:240px;padding:8px}
.ytable{font-size:.65rem;min-width:400px}
}
</style>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.1/kakao.min.js" crossorigin="anonymous" async></script>
</head>
<body>
<div class="hdr"><span class="hdr-title">연도별 시즌널리티 분석</span></div>
<div class="page">
  <nav class="coin-tabs" id="coinTabs"></nav>
  <div class="filter-tabs" id="filterTabs">
    <div class="ftab on" data-filter="all">전체</div>
    <div class="ftab" data-filter="us_president">미국 대선</div>
    <div class="ftab" data-filter="us_midterm">미국 중간선거</div>
  </div>
  <div class="chart-card">
    <div class="chart-head">
      <h3 id="chartTitle">2026년 Bitcoin 가격 시나리오</h3>
      <div class="chart-legend">
        <div class="leg"><span class="ldot best"></span>역대 최고</div>
        <div class="leg"><span class="ldot worst"></span>역대 최저</div>
        <div class="leg"><span class="ldot avg"></span>평균</div>
        <div class="leg"><span class="ldot cur"></span>현재 <span id="curYear">2026</span></div>
        <div class="leg"><span class="ldot sel"></span>선택됨</div>
      </div>
    </div>
    <div class="chart-area"><canvas id="yearlyChart"></canvas></div>
    <div class="inline-share" id="inlineShare1"></div>
  </div>
  <div class="chart-card">
    <div class="chart-head"><h3>연도별 수익률 비교</h3><span style="font-size:.6rem;color:var(--t4);font-family:'JetBrains Mono',monospace">연도 클릭 시 차트 반영</span></div>
    <div style="padding:0"><div class="ytable-wrap"><table class="ytable"><thead><tr><th>연도</th><th class="r">연간 수익률</th><th class="r">최고 시나리오</th><th class="r">최저 시나리오</th></tr></thead><tbody id="ytBody"></tbody></table></div></div>
    <div class="inline-share" id="inlineShare2"></div>
  </div>
  <div id="shareBarWrap"></div>
</div>
<script>
var SHARE_URL='https://herdvibe.com/26';
var KAKAO_KEY='a43ed7b39fac35458f4f9df925a279b5';
var DATA_BASE='https://raw.githubusercontent.com/kittycapital/crypto-history/main/data/';
var COINS=[
  {id:'bitcoin',name:'Bitcoin',sym:'btcusdt',icon:'https://raw.githubusercontent.com/kittycapital/crypto-history/main/assets/bitcoin.svg'},
  {id:'ethereum',name:'Ethereum',sym:'ethusdt',icon:'https://raw.githubusercontent.com/kittycapital/crypto-history/main/assets/ethereum.png'},
  {id:'solana',name:'Solana',sym:'solusdt',icon:'https://raw.githubusercontent.com/kittycapital/crypto-history/main/assets/solana.png'},
  {id:'xrp',name:'XRP',sym:'xrpusdt',icon:'https://raw.githubusercontent.com/kittycapital/crypto-history/main/assets/xrp.svg'},
  {id:'bnb',name:'BNB',sym:'bnbusdt',icon:'https://raw.githubusercontent.com/kittycapital/crypto-history/main/assets/bnb.png'}
];
var COIN_KR={bitcoin:'비트코인',ethereum:'이더리움',solana:'솔라나',xrp:'XRP',bnb:'BNB'};
var MONTH_KR=['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
var currentCoin='bitcoin',dataCache={},yearlyChart=null,selectedYear=null,currentFilter='all';

var ELECTION_YEARS={us_president:[],us_midterm:[]};
(function(){for(var y=1960;y<=2040;y++){if(y%4===0)ELECTION_YEARS.us_president.push(y);if(y%4===2)ELECTION_YEARS.us_midterm.push(y);}})();
function filterYears(years){if(currentFilter==='all')return years;var ey=ELECTION_YEARS[currentFilter]||[];return years.filter(function(y){return ey.indexOf(y)!==-1;});}

/* ===== WEBSOCKET ===== */
function initWS(){var streams=COINS.map(function(c){return c.sym+'@ticker';}).join('/');var ws=new WebSocket('wss://stream.binance.com:9443/stream?streams='+streams);ws.onmessage=function(e){var d=JSON.parse(e.data);var sym=d.stream.split('@')[0];var price=parseFloat(d.data.c);COINS.forEach(function(c){if(c.sym===sym){var el=document.getElementById('price-'+c.id);if(el){el.textContent=fmtPrice(price);el.classList.add('live');}}});};ws.onerror=function(){document.querySelectorAll('.ctab-price').forEach(function(el){el.textContent='-';});};}
function fmtPrice(p){return p>=1000?'$'+p.toLocaleString('en-US',{maximumFractionDigits:0}):p>=1?'$'+p.toFixed(2):'$'+p.toFixed(4);}

/* ===== SHARE ===== */
function ensureKakao(){try{if(typeof Kakao!=='undefined'&&!Kakao.isInitialized())Kakao.init(KAKAO_KEY);return typeof Kakao!=='undefined'&&Kakao.isInitialized();}catch(e){return false;}}
function copyToClipboard(t){try{window.parent.postMessage({type:'clipboard',text:t},'*');}catch(e){}try{navigator.clipboard.writeText(t);}catch(e){}}
function flashCopied(btn){if(!btn)return;var orig=btn.innerHTML;btn.style.background='#22c55e';btn.style.color='#fff';btn.style.borderColor='#22c55e';var hl=btn.querySelector('.lbl');btn.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"><path d="M5 13l4 4L19 7"/></svg>'+(hl?'<span class="lbl" style="color:#fff">복사됨!</span>':'');setTimeout(function(){btn.style.background='';btn.style.color='';btn.style.borderColor='';btn.innerHTML=orig;},2000);}
function kakaoShare(title){if(!ensureKakao()){copyToClipboard(SHARE_URL);showToast('링크 복사완료! 카카오톡에 붙여넣기 하세요');return;}try{Kakao.Share.sendDefault({objectType:'feed',content:{title:title||document.title,description:'연도별 시즌널리티 분석',imageUrl:'https://raw.githubusercontent.com/kittycapital/kittycapital.github.io/main/assets/herdvibe-og.png',link:{mobileWebUrl:SHARE_URL,webUrl:SHARE_URL}},buttons:[{title:'대시보드 보기',link:{mobileWebUrl:SHARE_URL,webUrl:SHARE_URL}}]});}catch(e){copyToClipboard(SHARE_URL);showToast('링크 복사완료! 카카오톡에 붙여넣기 하세요');}}
function showToast(msg){var w=document.querySelector('.toast-wrap');if(!w){w=document.createElement('div');w.className='toast-wrap';document.body.appendChild(w);}var t=document.createElement('div');t.className='toast';t.textContent=msg;w.appendChild(t);setTimeout(function(){t.style.opacity='0';t.style.transform='translateY(12px)';t.style.transition='.3s';setTimeout(function(){t.remove();},300);},3000);}
function doShare(p,btn){var cn=COIN_KR[currentCoin]||'암호화폐';var yr=new Date().getFullYear();var title=yr+'년 '+cn+' 시즌널리티 분석 — herdvibe.com';switch(p){case'twitter':window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(title)+'&url='+encodeURIComponent(SHARE_URL),'_blank');break;case'telegram':window.open('https://t.me/share/url?url='+encodeURIComponent(SHARE_URL)+'&text='+encodeURIComponent(title),'_blank');break;case'kakao':kakaoShare(title);break;case'instagram':copyToClipboard(SHARE_URL);flashCopied(btn);showToast('링크 복사완료! 인스타그램에 붙여넣기 하세요');break;case'link':copyToClipboard(SHARE_URL);flashCopied(btn);showToast('링크가 복사되었습니다 ✓');break;}}
var xI='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>';
var kI='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C6.477 3 2 6.463 2 10.691c0 2.724 1.8 5.112 4.508 6.458l-1.148 4.265a.5.5 0 0 0 .764.533l4.94-3.26c.304.02.612.03.936.03 5.523 0 10-3.462 10-7.735C22 6.463 17.523 3 12 3z"/></svg>';
var tI='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>';
var iI='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>';
var lI='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
function makeInlineShare(el){el.innerHTML='<span class="lbl">공유</span><button class="share-btn share-btn--x" onclick="doShare(\'twitter\',this)">'+xI+'</button><button class="share-btn share-btn--kakao" onclick="doShare(\'kakao\',this)">'+kI+'</button><button class="share-btn share-btn--tg" onclick="doShare(\'telegram\',this)">'+tI+'</button><button class="share-btn share-btn--copy" onclick="doShare(\'link\',this)">'+lI+'</button>';}
function makeShareBar(el){var cn=COIN_KR[currentCoin]||'암호화폐';var yr=new Date().getFullYear();el.innerHTML='<div class="share-bar"><div class="share-bar-preview"><b>'+yr+'년 '+cn+' 시즌널리티 분석</b> — herdvibe.com</div><div class="share-bar-buttons"><button class="share-btn share-btn--x" onclick="doShare(\'twitter\',this)">'+xI+'<span class="lbl">트위터</span></button><button class="share-btn share-btn--kakao" onclick="doShare(\'kakao\',this)">'+kI+'<span class="lbl">카카오톡</span></button><button class="share-btn share-btn--tg" onclick="doShare(\'telegram\',this)">'+tI+'<span class="lbl">텔레그램</span></button><button class="share-btn share-btn--ig" onclick="doShare(\'instagram\',this)">'+iI+'<span class="lbl">인스타</span></button><button class="share-btn share-btn--copy" onclick="doShare(\'link\',this)">'+lI+'<span class="lbl">링크 복사</span></button></div></div>';}

/* ===== TABS ===== */
function renderTabs(){
  var wrap=document.getElementById('coinTabs');
  var html='';COINS.forEach(function(c){html+='<div class="ctab'+(c.id===currentCoin?' on':'')+'" data-id="'+c.id+'"><div class="ctab-icon"><img src="'+c.icon+'" alt="'+c.name+'"></div><div class="ctab-info"><span class="ctab-name">'+c.name+'</span><span class="ctab-price" id="price-'+c.id+'">연결중...</span></div></div>';});
  wrap.innerHTML=html;
  wrap.querySelectorAll('.ctab').forEach(function(tab){tab.addEventListener('click',function(){currentCoin=tab.dataset.id;selectedYear=null;wrap.querySelectorAll('.ctab').forEach(function(t){t.classList.remove('on');});tab.classList.add('on');updateAll();});});
}

/* ===== DATA ===== */
async function loadData(id){
  if(dataCache[id])return dataCache[id];
  try{var r=await fetch(DATA_BASE+id+'.csv');var text=await r.text();var lines=text.trim().split('\n');var data=[];for(var i=1;i<lines.length;i++){var p=lines[i].split(',');var price=parseFloat(p[1]);if(!isNaN(price)&&p[0]){data.push({date:new Date(p[0].replace(' UTC','')),price:price});}}data.sort(function(a,b){return a.date-b.date;});dataCache[id]=data;return data;}catch(e){console.error('Load failed:',id,e);return[];}
}
function calcMonthlyReturns(data){
  var md={};data.forEach(function(d){var y=d.date.getFullYear(),m=d.date.getMonth(),day=d.date.getDate();var k=y+'-'+m;if(!md[k])md[k]={year:y,month:m,days:{}};md[k].days[day]=d.price;});
  var ret=[];for(var k in md){var m=md[k];var days=Object.keys(m.days).map(Number).sort(function(a,b){return a-b;});if(days.length>=2){var o=m.days[days[0]],c=m.days[days[days.length-1]];ret.push({year:m.year,month:m.month,return:((c-o)/o)*100});}}return ret;
}

/* ===== CHART ===== */
Chart.defaults.color='#555';Chart.defaults.borderColor='rgba(255,255,255,0.06)';Chart.defaults.font.family="'Noto Sans KR',sans-serif";
var wmPlugin={id:'herdvibeWM',beforeDraw:function(c){var ctx=c.ctx,ca=c.chartArea;if(!ca)return;ctx.save();ctx.font='700 34px "Plus Jakarta Sans",sans-serif';ctx.fillStyle='rgba(255,255,255,0.035)';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Herdvibe.com',(ca.left+ca.right)/2,(ca.top+ca.bottom)/2);ctx.restore();}};

function calcScenarios(data,monthlyReturns){
  var curYear=new Date().getFullYear();
  var yearlyData={};data.forEach(function(d){var y=d.date.getFullYear(),m=d.date.getMonth(),day=d.date.getDate();if(!yearlyData[y])yearlyData[y]={};if(!yearlyData[y][m])yearlyData[y][m]={};yearlyData[y][m][day]=d.price;});
  var basePrice=null;
  if(yearlyData[curYear]&&yearlyData[curYear][0]){var jd=Object.keys(yearlyData[curYear][0]).map(Number).sort(function(a,b){return a-b;});if(jd.length>0)basePrice=yearlyData[curYear][0][jd[0]];}
  if(!basePrice)return null;
  var yearlyReturns={};monthlyReturns.forEach(function(r){if(r.year!==curYear){if(!yearlyReturns[r.year])yearlyReturns[r.year]={};yearlyReturns[r.year][r.month]=r.return;}});
  var monthStats={avg:{}};
  for(var m=0;m<12;m++){var vals=[];for(var y in yearlyReturns){if(yearlyReturns[y][m]!==undefined)vals.push(yearlyReturns[y][m]);}if(vals.length>0)monthStats.avg[m]=vals.reduce(function(a,b){return a+b;},0)/vals.length;}
  var scenarios=[];var bestYear=null,worstYear=null,bestFR=-Infinity,worstFR=Infinity;
  var filteredYears=filterYears(Object.keys(yearlyReturns).map(Number)).sort();
  var fMonthStats={avg:{}};
  for(var m=0;m<12;m++){var fv=[];filteredYears.forEach(function(y){if(yearlyReturns[y]&&yearlyReturns[y][m]!==undefined)fv.push(yearlyReturns[y][m]);});if(fv.length>0)fMonthStats.avg[m]=fv.reduce(function(a,b){return a+b;},0)/fv.length;}
  filteredYears.forEach(function(year){var pts=[];var cp=basePrice;for(var m=0;m<12;m++){var mr=yearlyReturns[year][m];if(mr!==undefined)cp=cp*(1+mr/100);pts.push({month:m,price:cp});}var fr=((cp-basePrice)/basePrice)*100;if(fr>bestFR){bestFR=fr;bestYear=year;}if(fr<worstFR){worstFR=fr;worstYear=year;}scenarios.push({year:year,data:pts,finalReturn:fr});});
  var avgPts=[];var ap=basePrice;for(var m=0;m<12;m++){if(fMonthStats.avg[m]!==undefined)ap=ap*(1+fMonthStats.avg[m]/100);avgPts.push({month:m,price:ap});}
  var curPts=[];if(yearlyData[curYear]){var lp=basePrice;for(var m=0;m<12;m++){if(yearlyData[curYear][m]){var dd=Object.keys(yearlyData[curYear][m]).map(Number).sort(function(a,b){return a-b;});if(dd.length>0){lp=yearlyData[curYear][m][dd[dd.length-1]];curPts.push({month:m,price:lp});}}}}
  return{scenarios:scenarios,bestYear:bestYear,worstYear:worstYear,avgData:avgPts,currentData:curPts,basePrice:basePrice,curYear:curYear};
}

function renderChart(data,monthlyReturns){
  var ctx=document.getElementById('yearlyChart').getContext('2d');if(yearlyChart)yearlyChart.destroy();
  var sc=calcScenarios(data,monthlyReturns);if(!sc)return null;
  var ds=[];
  sc.scenarios.forEach(function(s){if(s.year!==sc.bestYear&&s.year!==sc.worstYear&&s.year!==selectedYear){ds.push({label:s.year+'',data:s.data.map(function(d){return{x:d.month,y:d.price};}),borderColor:'rgba(255,255,255,0.08)',borderWidth:1.5,fill:false,tension:.3,pointRadius:0,pointHoverRadius:4});}});
  ds.push({label:'평균',data:sc.avgData.map(function(d){return{x:d.month,y:d.price};}),borderColor:'#888',borderWidth:2,borderDash:[5,5],fill:false,tension:.3,pointRadius:0});
  if(selectedYear){var sl=sc.scenarios.find(function(s){return s.year===selectedYear;});if(sl)ds.push({label:selectedYear+' (선택)',data:sl.data.map(function(d){return{x:d.month,y:d.price};}),borderColor:'#60a5fa',borderWidth:3,fill:false,tension:.3,pointRadius:0});}
  var ws=sc.scenarios.find(function(s){return s.year===sc.worstYear;});if(ws)ds.push({label:sc.worstYear+' (역대 최저)',data:ws.data.map(function(d){return{x:d.month,y:d.price};}),borderColor:'#ff4466',borderWidth:2.5,fill:false,tension:.3,pointRadius:0});
  var bs=sc.scenarios.find(function(s){return s.year===sc.bestYear;});if(bs)ds.push({label:sc.bestYear+' (역대 최고)',data:bs.data.map(function(d){return{x:d.month,y:d.price};}),borderColor:'#00ff88',borderWidth:2.5,fill:false,tension:.3,pointRadius:0});
  if(sc.currentData.length>0)ds.push({label:sc.curYear+' (현재)',data:sc.currentData.map(function(d){return{x:d.month,y:d.price};}),borderColor:'#ffcc00',borderWidth:3,fill:false,tension:.3,pointRadius:3,pointBackgroundColor:'#ffcc00'});
  var basePrice=sc.basePrice;
  yearlyChart=new Chart(ctx,{type:'line',plugins:[wmPlugin],data:{datasets:ds},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'nearest',intersect:false},plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(10,10,10,.95)',titleColor:'#e8e8f0',bodyColor:'#8888a0',borderColor:'rgba(255,255,255,.08)',borderWidth:1,padding:12,callbacks:{title:function(it){return it.length>0?MONTH_KR[Math.round(it[0].parsed.x)]||'':'';},label:function(ctx){var p=ctx.parsed.y;var r=((p-basePrice)/basePrice)*100;var s=r>=0?'+':'';return' '+ctx.dataset.label+': '+fmtPrice(p)+' ('+s+r.toFixed(1)+'%)';}}}},scales:{x:{type:'linear',min:0,max:11,title:{display:true,text:'월',color:'#888'},grid:{color:'rgba(255,255,255,.03)'},ticks:{color:'#888',stepSize:1,callback:function(v){return MONTH_KR[v]||'';}}},y:{title:{display:true,text:'가격 (USD)',color:'#888'},grid:{color:'rgba(255,255,255,.03)'},ticks:{color:'#888',callback:function(v){return fmtPrice(v);}}}}}});
  return sc;
}

function renderTable(sc){
  if(!sc)return;var tbody=document.getElementById('ytBody');tbody.innerHTML='';
  var sorted=sc.scenarios.slice().sort(function(a,b){return b.finalReturn-a.finalReturn;});
  var bs=sc.scenarios.find(function(s){return s.year===sc.bestYear;});
  var ws=sc.scenarios.find(function(s){return s.year===sc.worstYear;});
  var bestP=bs?fmtPrice(bs.data[bs.data.length-1].price):'--';
  var worstP=ws?fmtPrice(ws.data[ws.data.length-1].price):'--';
  sorted.forEach(function(s){
    var row=document.createElement('tr');row.dataset.year=s.year;
    if(s.year===selectedYear)row.className='sel';
    var yc=document.createElement('td');yc.className='yr-cell';yc.textContent=s.year;
    var rc=document.createElement('td');rc.className='r '+(s.finalReturn>=0?'up':'dn');rc.textContent=(s.finalReturn>=0?'+':'')+s.finalReturn.toFixed(1)+'%';
    var hc=document.createElement('td');hc.className='r';hc.textContent=bestP;
    var lc=document.createElement('td');lc.className='r';lc.textContent=worstP;
    row.appendChild(yc);row.appendChild(rc);row.appendChild(hc);row.appendChild(lc);
    row.addEventListener('click',function(){var was=row.classList.contains('sel');document.querySelectorAll('.ytable tr.sel').forEach(function(r){r.classList.remove('sel');});if(was){selectedYear=null;}else{row.classList.add('sel');selectedYear=parseInt(row.dataset.year);}updateAll();});
    tbody.appendChild(row);
  });
}

/* ===== UPDATE ===== */
async function updateAll(){
  var data=await loadData(currentCoin);if(!data.length)return;
  var returns=calcMonthlyReturns(data);
  var curYear=new Date().getFullYear();
  var cn=COIN_KR[currentCoin]||currentCoin;
  var filterNames={all:'',us_president:' (미국 대선)',us_midterm:' (미국 중간선거)'};
  document.getElementById('curYear').textContent=curYear;
  document.getElementById('chartTitle').textContent=curYear+'년 '+cn+' 가격 시나리오'+(filterNames[currentFilter]||'');
  var sc=renderChart(data,returns);
  renderTable(sc);
  makeInlineShare(document.getElementById('inlineShare1'));
  makeInlineShare(document.getElementById('inlineShare2'));
  makeShareBar(document.getElementById('shareBarWrap'));
}

/* ===== IFRAME RESIZE ===== */
(function(){var lastH=0;setInterval(function(){if(window.parent!==window){var h=document.body.scrollHeight;if(h!==lastH){lastH=h;window.parent.postMessage({type:'resize',height:h},'*');}}},300);})();

document.addEventListener('DOMContentLoaded',function(){
  renderTabs();initWS();
  document.querySelectorAll('.ftab').forEach(function(tab){tab.addEventListener('click',function(){document.querySelectorAll('.ftab').forEach(function(t){t.classList.remove('on');});tab.classList.add('on');currentFilter=tab.dataset.filter;selectedYear=null;updateAll();});});
  updateAll();
});
</script>
</body>
</html>
